<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turno Hoje - OBRAS BA</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Barlow',sans-serif; background:#f0f2f5; min-height:100vh; padding-bottom:80px; }

.header { background:linear-gradient(135deg,#1a7a4a 0%,#25a060 60%,#1a7a4a 100%); padding:28px 20px 18px; text-align:center; position:relative; overflow:hidden; }
.header::before { content:''; position:absolute; inset:0; background:repeating-linear-gradient(45deg,rgba(255,255,255,0.03) 0,rgba(255,255,255,0.03) 1px,transparent 1px,transparent 20px); }
.header-title { font-size:2.4rem; font-weight:800; color:#fff; letter-spacing:1px; text-shadow:0 2px 8px rgba(0,0,0,0.2); position:relative; }
.header-sub   { font-size:0.85rem; font-weight:600; color:rgba(255,255,255,0.85); letter-spacing:3px; text-transform:uppercase; margin-top:4px; position:relative; }
.header-time  { font-size:0.78rem; font-weight:600; color:rgba(255,255,255,0.7); letter-spacing:1px; margin-top:6px; position:relative; }
.header-bar   { height:5px; background:linear-gradient(90deg,#f5c518,#ffdd57,#f5c518); }
.db-badge { display:inline-flex; align-items:center; gap:5px; font-size:0.7rem; font-weight:800; padding:4px 12px; border-radius:20px; letter-spacing:0.5px; margin-top:10px; position:relative; }
.db-badge.offline { background:rgba(229,62,62,0.3); color:#ffc0c0; }
.db-badge.online  { background:rgba(45,184,100,0.3); color:#b0ffd0; }
.db-badge.syncing { background:rgba(240,165,0,0.3);  color:#ffe9a0; }
.db-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.db-badge.offline .db-dot { background:#e53e3e; }
.db-badge.online  .db-dot { background:#2db864; box-shadow:0 0 6px #2db864; }
.db-badge.syncing .db-dot { background:#f0a500; animation:blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

.container { max-width:1120px; margin:30px auto; padding:0 16px; }
.section { background:#fff; border-radius:12px; margin-bottom:24px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.07); }
.section-header { display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid #e8ecef; }
.section-header.green  { background:#f0faf4; border-bottom-color:#d0ead9; }
.section-header.red    { background:#fff5f5; border-bottom-color:#fdd; }
.section-header.orange { background:#fffbf0; border-bottom-color:#fde8b0; }
.section-header.blue   { background:#ebf4ff; border-bottom-color:#bee3f8; }
.section-label { display:flex; align-items:center; gap:10px; font-size:1rem; font-weight:800; letter-spacing:0.5px; color:#222; }
.icon-check { width:24px; height:24px; border-radius:6px; background:#2db864; color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.9rem; }
.icon-dot   { width:14px; height:14px; border-radius:50%; background:#e53e3e; }
.icon-warn  { width:24px; height:24px; border-radius:6px; background:#f0a500; color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.9rem; }
.icon-blue  { width:24px; height:24px; border-radius:6px; background:#2b6cb0; color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.9rem; }
.section-count { font-size:1.3rem; font-weight:800; }
.section-count.green  { color:#1a7a4a; }
.section-count.red    { color:#c53030; }
.section-count.orange { color:#b97400; }
.section-count.blue   { color:#2b6cb0; }

.grid { display:grid; grid-template-columns:repeat(4,1fr); gap:0; min-height:10px; }
.card { display:flex; align-items:center; justify-content:space-between; padding:11px 14px; border-right:1px solid #edf0f2; border-bottom:1px solid #edf0f2; gap:8px; transition:background 0.15s; }
.card:hover { background:#f9fbff; }
.card:nth-child(4n) { border-right:none; }
.card.absent { background:#fff8f8; }
.card.absent:hover { background:#fff0f0; }
.card.justif { background:#fffdf0; position:relative; cursor:default; }
.card.justif:hover { background:#fff8dc; }
.card-name { font-size:0.82rem; font-weight:700; color:#2d3748; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
.card.absent .card-name { color:#742a2a; }
.card.justif .card-name { color:#7a4f00; }
.justif-obs { display:none; position:absolute; bottom:calc(100%+6px); left:0; z-index:50; background:#333; color:#fff; font-size:0.72rem; font-weight:600; padding:6px 10px; border-radius:7px; max-width:240px; white-space:normal; box-shadow:0 4px 14px rgba(0,0,0,0.2); line-height:1.4; }
.card.justif:hover .justif-obs { display:block; }
.justif-obs::after { content:''; position:absolute; top:100%; left:16px; border:6px solid transparent; border-top-color:#333; }

.prod-card { display:flex; flex-direction:column; padding:11px 14px; border-right:1px solid #edf0f2; border-bottom:1px solid #edf0f2; gap:4px; transition:background 0.15s; }
.prod-card:hover { background:#f0f7ff; }
.prod-card:nth-child(4n) { border-right:none; }
.prod-card.pending { background:#f9fafb; }
.prod-card.pending:hover { background:#f0f0f5; }
.prod-top { display:flex; align-items:center; justify-content:space-between; gap:6px; }
.prod-name { font-size:0.82rem; font-weight:700; color:#1a365d; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
.prod-card.pending .prod-name { color:#718096; }
.prod-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-top:2px; }
.prod-info { font-size:0.68rem; font-weight:700; color:#888; }
.prod-info.val { color:#276749; font-weight:800; }
.prod-info.lan { color:#2b6cb0; font-weight:800; }
.section-divider { margin:0 20px; font-size:0.7rem; font-weight:800; color:#aaa; letter-spacing:1.5px; text-transform:uppercase; padding:8px 0 6px; border-top:1px solid #f0f2f5; }

.badge { flex-shrink:0; font-size:0.68rem; font-weight:800; letter-spacing:0.5px; padding:3px 9px; border-radius:5px; text-transform:uppercase; }
.badge.ok     { background:#2db864; color:#fff; }
.badge.falta  { background:#e53e3e; color:#fff; }
.badge.justif { background:#f0a500; color:#fff; }
.badge.lancou { background:#2b6cb0; color:#fff; }
.badge.aguard { background:#a0aec0; color:#fff; }
.badge.exec   { background:#276749; color:#fff; font-size:0.6rem; }
.badge.semac  { background:#c05621; color:#fff; font-size:0.6rem; }
.badge.chuva  { background:#2c5282; color:#fff; font-size:0.6rem; }
.badge.naexec { background:#742a2a; color:#fff; font-size:0.6rem; }

.footer { text-align:center; font-size:0.75rem; color:#aaa; margin-top:10px; font-weight:600; letter-spacing:0.5px; }

.loading-overlay { display:none; position:fixed; inset:0; background:rgba(26,122,74,0.93); z-index:999; align-items:center; justify-content:center; flex-direction:column; gap:14px; }
.loading-overlay.show { display:flex; }
.loading-spinner { width:48px; height:48px; border:5px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin2 0.8s linear infinite; }
.loading-text { color:#fff; font-weight:800; font-size:1rem; letter-spacing:0.5px; }
@keyframes spin2 { to{transform:rotate(360deg)} }

.fab        { position:fixed; bottom:28px; right:28px; background:#1a7a4a; color:#fff; border:none; border-radius:50px; padding:14px 24px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:800; letter-spacing:0.5px; cursor:pointer; box-shadow:0 4px 20px rgba(26,122,74,0.45); display:flex; align-items:center; gap:8px; transition:all 0.2s; z-index:100; }
.fab:hover  { background:#145f39; transform:translateY(-2px); }
.btn-print  { position:fixed; bottom:28px; left:28px; background:#2b6cb0; color:#fff; border:none; border-radius:50px; padding:14px 24px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:800; letter-spacing:0.5px; cursor:pointer; box-shadow:0 4px 20px rgba(43,108,176,0.4); display:flex; align-items:center; gap:8px; transition:all 0.2s; z-index:100; }
.btn-print:hover { background:#1a4a80; transform:translateY(-2px); }
.btn-refresh { position:fixed; bottom:28px; left:220px; background:#6b46c1; color:#fff; border:none; border-radius:50px; padding:14px 24px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:800; letter-spacing:0.5px; cursor:pointer; box-shadow:0 4px 20px rgba(107,70,193,0.4); display:flex; align-items:center; gap:8px; transition:all 0.2s; z-index:100; }
.btn-refresh:hover { background:#553c9a; transform:translateY(-2px); }
@keyframes spin { to{transform:rotate(360deg)} }
.spinning-icon { display:inline-block; animation:spin 0.7s linear infinite; }

.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center; padding:16px; }
.modal-overlay.open { display:flex; }
.modal { background:#fff; border-radius:16px; width:100%; max-width:600px; box-shadow:0 20px 60px rgba(0,0,0,0.2); overflow:hidden; max-height:94vh; display:flex; flex-direction:column; }
.modal-header { background:linear-gradient(135deg,#1a7a4a,#25a060); padding:18px 24px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
.modal-header h2 { color:#fff; font-size:1.1rem; font-weight:800; }
.modal-close { background:rgba(255,255,255,0.2); border:none; color:#fff; width:30px; height:30px; border-radius:8px; cursor:pointer; font-size:1.1rem; font-weight:800; display:flex; align-items:center; justify-content:center; }
.modal-close:hover { background:rgba(255,255,255,0.35); }
.modal-body { padding:24px; overflow-y:auto; }

.modal-tabs { display:flex; gap:6px; margin-bottom:20px; flex-wrap:wrap; }
.tab-btn { flex:1; min-width:80px; padding:9px 6px; border:2px solid #e2e8f0; border-radius:8px; background:#f7f9fc; font-family:'Barlow',sans-serif; font-size:0.75rem; font-weight:800; color:#666; cursor:pointer; transition:all 0.15s; text-align:center; }
.tab-btn.active-tab { background:#1a7a4a; border-color:#1a7a4a; color:#fff; }

.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:0.78rem; font-weight:800; color:#555; letter-spacing:0.5px; text-transform:uppercase; margin-bottom:6px; }
.form-input { width:100%; padding:10px 14px; border:2px solid #e2e8f0; border-radius:8px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:600; color:#2d3748; outline:none; transition:border-color 0.15s; }
.form-input:focus { border-color:#25a060; }
.radio-group { display:flex; gap:8px; }
.radio-opt { flex:1; padding:9px 6px; border:2px solid #e2e8f0; border-radius:8px; cursor:pointer; text-align:center; font-size:0.78rem; font-weight:800; color:#666; transition:all 0.15s; user-select:none; }
.radio-opt.sel-ok     { background:#f0faf4; border-color:#2db864; color:#1a7a4a; }
.radio-opt.sel-justif { background:#fffbf0; border-color:#f0a500; color:#b97400; }
.radio-opt.sel-falta  { background:#fff5f5; border-color:#e53e3e; color:#c53030; }
.btn-primary { width:100%; padding:12px; background:#1a7a4a; color:#fff; border:none; border-radius:8px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:800; cursor:pointer; transition:background 0.15s; margin-top:4px; }
.btn-primary:hover { background:#145f39; }
.btn-danger { width:100%; padding:12px; background:#c53030; color:#fff; border:none; border-radius:8px; font-family:'Barlow',sans-serif; font-size:0.9rem; font-weight:800; cursor:pointer; transition:background 0.15s; margin-top:8px; }
.btn-danger:hover { background:#9b2626; }
.msg { font-size:0.78rem; font-weight:700; padding:8px 12px; border-radius:7px; margin-top:10px; display:none; }
.msg.success { background:#d4f5e2; color:#1a7a4a; display:block; }
.msg.error   { background:#fde8e8; color:#c53030; display:block; }

.date-row { display:flex; align-items:center; gap:10px; margin-bottom:20px; padding:12px 14px; background:#f7f9fc; border-radius:8px; border:1px solid #e2e8f0; }
.date-row label { font-size:0.78rem; font-weight:800; color:#555; letter-spacing:0.5px; text-transform:uppercase; white-space:nowrap; }
.date-row input { flex:1; padding:7px 12px; border:2px solid #e2e8f0; border-radius:7px; font-family:'Barlow',sans-serif; font-size:0.88rem; font-weight:600; color:#2d3748; outline:none; }
.date-row input:focus { border-color:#25a060; }
.btn-date { padding:8px 14px; background:#1a7a4a; color:#fff; border:none; border-radius:7px; font-family:'Barlow',sans-serif; font-size:0.8rem; font-weight:800; cursor:pointer; white-space:nowrap; }
.btn-date:hover { background:#145f39; }

.team-list { max-height:280px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; margin-top:10px; }
.team-row { display:flex; align-items:center; justify-content:space-between; padding:9px 14px; border-bottom:1px solid #f0f2f5; gap:8px; flex-wrap:wrap; }
.team-row:last-child { border-bottom:none; }
.team-row:hover { background:#f9f9f9; }
.team-row-name { font-size:0.82rem; font-weight:700; color:#2d3748; flex:1; }
.team-row-acts { display:flex; gap:5px; flex-wrap:wrap; }
.pill { font-size:0.65rem; font-weight:800; padding:2px 8px; border-radius:4px; text-transform:uppercase; }
.pill.ok     { background:#d4f5e2; color:#1a7a4a; }
.pill.justif { background:#fef3cd; color:#b97400; }
.pill.falta  { background:#fde8e8; color:#c53030; }
.btn-sm { padding:4px 10px; border:none; border-radius:5px; font-family:'Barlow',sans-serif; font-size:0.7rem; font-weight:800; cursor:pointer; transition:opacity 0.15s; }
.btn-sm:hover { opacity:0.75; }
.btn-sm.to-ok     { background:#d4f5e2; color:#1a7a4a; }
.btn-sm.to-justif { background:#fef3cd; color:#b97400; }
.btn-sm.to-falta  { background:#fde8e8; color:#c53030; }
.btn-sm.del       { background:#f0f0f0; color:#555; }

.drop-zone { border:2px dashed #bee3f8; border-radius:10px; padding:32px 16px; text-align:center; cursor:pointer; transition:all 0.2s; background:#f0f7ff; margin-bottom:16px; }
.drop-zone:hover,.drop-zone.dragover { background:#dbeffe; border-color:#2b6cb0; }
.drop-zone-icon { font-size:2rem; margin-bottom:8px; }
.drop-zone-text { font-size:0.85rem; font-weight:700; color:#2b6cb0; }
.drop-zone-sub  { font-size:0.72rem; font-weight:600; color:#888; margin-top:4px; }
.prod-summary { background:#ebf4ff; border:1px solid #bee3f8; border-radius:8px; padding:14px 16px; margin-bottom:12px; display:none; }
.prod-summary-title { font-size:0.78rem; font-weight:800; color:#2b6cb0; letter-spacing:0.5px; text-transform:uppercase; margin-bottom:8px; }
.prod-summary-stats { display:flex; gap:16px; flex-wrap:wrap; }
.prod-stat-val { font-size:1.1rem; font-weight:800; color:#1a365d; display:block; }
.prod-stat-lbl { font-size:0.68rem; font-weight:700; color:#888; text-transform:uppercase; }

@media print {
  body { background:#fff; padding-bottom:0; }
  .fab,.modal-overlay,.btn-print,.btn-refresh,.loading-overlay { display:none !important; }
  .section { box-shadow:none; border:1px solid #e0e0e0; }
  * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
}
@media (max-width:768px) {
  .grid { grid-template-columns:repeat(2,1fr); }
  .card:nth-child(4n),.prod-card:nth-child(4n) { border-right:1px solid #edf0f2; }
  .card:nth-child(2n),.prod-card:nth-child(2n) { border-right:none; }
  .header-title { font-size:1.6rem; }
  .btn-refresh { left:auto; right:28px; bottom:90px; }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Conectando ao banco de dados...</div>
</div>

<div class="header">
  <div class="header-title" id="page-title">TURNO HOJE</div>
  <div class="header-sub" id="page-sub">RelatÃ³rio</div>
  <div class="header-time" id="page-time"></div>
  <div class="db-badge offline" id="db-badge"><span class="db-dot"></span><span id="db-text">Conectando...</span></div>
</div>
<div class="header-bar"></div>

<div class="container">
  <div class="section">
    <div class="section-header green">
      <div class="section-label"><div class="icon-check">&#10003;</div> ABRIU TURNO</div>
      <div class="section-count green" id="ok-count">0</div>
    </div>
    <div class="grid" id="abriu-grid"></div>
  </div>
  <div class="section">
    <div class="section-header orange">
      <div class="section-label"><div class="icon-warn">!</div> FALTA JUSTIFICADA</div>
      <div class="section-count orange" id="justif-count">0</div>
    </div>
    <div class="grid" id="justif-grid"></div>
  </div>
  <div class="section">
    <div class="section-header red">
      <div class="section-label"><div class="icon-dot"></div> NAO ABRIU TURNO</div>
      <div class="section-count red" id="falta-count">0</div>
    </div>
    <div class="grid" id="falta-grid"></div>
  </div>
  <div class="section">
    <div class="section-header blue">
      <div class="section-label"><div class="icon-blue">&#128202;</div> LANCAMENTO DE PRODUCAO</div>
      <div style="display:flex;gap:12px;align-items:center;">
        <span style="font-size:0.72rem;font-weight:700;color:#2b6cb0;" id="prod-valor-total"></span>
        <div class="section-count blue" id="prod-lancou-count">0</div>
      </div>
    </div>
    <div class="section-divider">LANCOU &#8212; <span id="lbl-lancou">0</span> equipes</div>
    <div class="grid" id="prod-lancou-grid"></div>
    <div class="section-divider">AGUARDANDO &#8212; <span id="lbl-aguard">0</span> equipes</div>
    <div class="grid" id="prod-aguard-grid"></div>
  </div>
</div>

<div class="footer" id="footer-text"></div>

<button class="fab" onclick="openModal()">&#9881; GERENCIAR</button>
<button class="btn-print" onclick="tirarPrint()">&#128248; SALVAR PRINT</button>
<button class="btn-refresh" id="btn-refresh" onclick="atualizarRelatorio()">&#8635; ATUALIZAR</button>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>&#9881; GERENCIAR TURNOS</h2>
      <button class="modal-close" onclick="closeModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="date-row">
        <label>Data:</label>
        <input type="text" id="date-input" placeholder="DD/MM/AAAA">
        <button class="btn-date" onclick="updateDate()">Atualizar</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active-tab" id="tab-add-btn"    onclick="switchTab('add')">+ Adicionar</button>
        <button class="tab-btn"            id="tab-manage-btn" onclick="switchTab('manage')">Gerenciar</button>
        <button class="tab-btn"            id="tab-import-btn" onclick="switchTab('import')">ðŸ“‹ Importar CSV</button>
        <button class="tab-btn"            id="tab-prod-btn"   onclick="switchTab('prod')">Producao</button>
      </div>

      <div id="tab-add">
        <div class="form-group">
          <label class="form-label">Nome da Equipe</label>
          <input class="form-input" type="text" id="new-name" placeholder="Ex: JOAO-JAC"
            oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')addTeam()">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="radio-group">
            <div class="radio-opt sel-ok"  id="opt-ok"     onclick="selectStatus('ok')">OK ABRIU</div>
            <div class="radio-opt"         id="opt-justif" onclick="selectStatus('justif')">JUSTIF.</div>
            <div class="radio-opt"         id="opt-falta"  onclick="selectStatus('falta')">FALTA</div>
          </div>
        </div>
        <div class="form-group" id="obs-group" style="display:none">
          <label class="form-label">Motivo / Justificativa</label>
          <input class="form-input" type="text" id="new-obs" placeholder="Ex: Atestado medico, ferias...">
        </div>
        <button class="btn-primary" onclick="addTeam()">ADICIONAR</button>
        <div class="msg" id="add-msg"></div>
      </div>

      <div id="tab-manage" style="display:none">
        <input class="form-input" type="text" id="search-input" placeholder="Buscar equipe..." oninput="renderManageList()" style="margin-bottom:4px;">
        <div class="team-list" id="manage-list"></div>
      </div>

      <div id="tab-import" style="display:none">
        <div class="drop-zone" id="drop-zone-import" onclick="document.getElementById('csv-turno-file').click()"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="event.preventDefault();this.classList.remove('dragover');handleTurnoCSV(event.dataTransfer.files[0])">
          <div class="drop-zone-icon">ðŸ“‹</div>
          <div class="drop-zone-text">Clique ou arraste o CSV de turno aqui</div>
          <div class="drop-zone-sub">consulta_turno_*.csv â€” atualiza OK / Falta automaticamente</div>
        </div>
        <input type="file" id="csv-turno-file" accept=".csv" style="display:none" onchange="handleTurnoCSV(this.files[0])">
        <div class="msg" id="import-msg"></div>
      </div>

      <div id="tab-prod" style="display:none">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('csv-file').click()"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="event.preventDefault();this.classList.remove('dragover');handleCSV(event.dataTransfer.files[0])">
          <div class="drop-zone-icon">&#128193;</div>
          <div class="drop-zone-text">Clique ou arraste o CSV aqui</div>
          <div class="drop-zone-sub">apontamento_faturamento_*.csv (separado por ponto e virgula)</div>
        </div>
        <input type="file" id="csv-file" accept=".csv" style="display:none" onchange="handleCSV(this.files[0])">
        <div class="prod-summary" id="prod-summary">
          <div class="prod-summary-title">Resumo importado</div>
          <div class="prod-summary-stats" id="prod-summary-stats"></div>
        </div>
        <button class="btn-danger" onclick="limparProducao()">Limpar dados de producao</button>
        <div class="msg" id="prod-msg"></div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ SUPABASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPA_URL = 'https://eqxejfoibebcbtsqymji.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeGVqZm9pYmViY2J0c3F5bWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjUzMTEsImV4cCI6MjA4NzQ0MTMxMX0.lwf7_EJ6UchEOpzhW3cVKztxDGy78gaQblRvgiEwWh8';
// SDK removido - usando fetch nativo para evitar bloqueio no carregamento

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULTS = {
  date: '23/02/2026',
  ok: ['ALAN-IRC','ALEX-IRC','ANDRE-JAC','CAIQUE-JAC','CLEBSON-JAC','DIOGO-JAC','DOUGLAS-JAC','EDILSON-IRC','EDMILSON-IRC','ELIEZER-IRC','EMERSON-JAC','ENES-IRC','ESMERALDO-IRC','FABIANO-JAC','FELIPE-IRC','GABRIEL-IRC','GIORLAN-IRC','IRISMAR-IRC','JAILSON-IRC','JARBAS-IRC','JOAO-JAC','MARCOS-IRC','PATRICIO-JAC','RIAN-IRC','ROMERO-IRC','TIAGO-JAC','UBERDAN-IRC','VALMIR-JAC','VANILSON-IRC','WILIAN-IRC'],
  justif: [],
  falta: ['CARLOS-JAC','GERALDO-JAC','JAILTON-JAC','JAIR-JAC','JENILSON-JAC','JULIO-JAC','LUCIANO-JAC','MENEZES-IRC','REVERTON-IRC','RODRIGO-JAC','VAGNO-IRC','WASHINGTON-IRC','WESLEY-IRC']
};

let teams = { ok: [...DEFAULTS.ok], justif: [], falta: [...DEFAULTS.falta] };
let currentDate = DEFAULTS.date;
let producao = {};
let selectedStatus = 'ok';

// â”€â”€â”€ SUPABASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDbStatus(status, msg) {
  const b = document.getElementById('db-badge');
  b.className = 'db-badge ' + status;
  document.getElementById('db-text').textContent = msg;
}

async function dbLoad() {
  setDbStatus('syncing', 'Carregando...');
  const controller = new AbortController();
  const tid = setTimeout(() => controller.abort(), 4000);
  try {
    const res = await fetch(SUPA_URL + '/rest/v1/turno_data?select=key,value', {
      signal: controller.signal,
      headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
    });
    clearTimeout(tid);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      data.forEach(row => {
        if (row.key === 'turno') {
          const v = row.value;
          teams.ok     = v.ok     || DEFAULTS.ok;
          teams.justif = v.justif || [];
          teams.falta  = v.falta  || DEFAULTS.falta;
          currentDate  = v.date   || DEFAULTS.date;
        }
        if (row.key === 'producao') {
          producao = row.value || {};
        }
      });
    }
    setDbStatus('online', 'Banco online');
  } catch(e) {
    clearTimeout(tid);
    setDbStatus('offline', e.name === 'AbortError' ? 'Timeout' : 'Sem conexao');
  }
}

async function dbSaveTurno() {
  try {
    setDbStatus('syncing', 'Salvando...');
    const res = await fetch(SUPA_URL + '/rest/v1/turno_data', {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify({ key: 'turno', value: { date: currentDate, ok: teams.ok, justif: teams.justif, falta: teams.falta }, updated_at: new Date().toISOString() })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    setDbStatus('online', 'Salvo!');
    setTimeout(() => setDbStatus('online', 'Banco online'), 1500);
  } catch(e) {
    setDbStatus('offline', 'Erro ao salvar');
  }
}

async function dbSaveProducao() {
  try {
    setDbStatus('syncing', 'Salvando...');
    const res = await fetch(SUPA_URL + '/rest/v1/turno_data', {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify({ key: 'producao', value: producao, updated_at: new Date().toISOString() })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    setDbStatus('online', 'Banco online');
  } catch(e) {
    setDbStatus('offline', 'Erro ao salvar');
  }
}
// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  buildGridOk('abriu-grid', [...teams.ok].sort());
  buildGridJustif('justif-grid', [...teams.justif].sort((a,b)=>a.name.localeCompare(b.name)));
  buildGridFalta('falta-grid', [...teams.falta].sort());
  document.getElementById('ok-count').textContent    = teams.ok.length;
  document.getElementById('justif-count').textContent = teams.justif.length;
  document.getElementById('falta-count').textContent  = teams.falta.length;
  const total = teams.ok.length + teams.justif.length + teams.falta.length;
  document.getElementById('page-title').textContent = 'TURNO HOJE (' + currentDate + ')';
  document.getElementById('page-sub').textContent   = 'Relatorio: ' + currentDate;
  document.getElementById('date-input').value       = currentDate;
  document.getElementById('footer-text').innerHTML  =
    'OBRAS - BA &nbsp;|&nbsp; BA_PROCESSO &nbsp;|&nbsp; ' + total + ' equipes ativas &nbsp;|&nbsp; ' + currentDate;
  renderProducao();
}
function emptyMsg(id) {
  document.getElementById(id).innerHTML = '<div style="padding:18px;color:#bbb;font-size:0.82rem;font-weight:600;grid-column:1/-1;text-align:center;">Nenhuma equipe</div>';
}
function buildGridOk(id, list) {
  const g = document.getElementById(id); g.innerHTML = '';
  if (!list.length) { emptyMsg(id); return; }
  list.forEach(name => {
    const d = document.createElement('div'); d.className = 'card';
    d.innerHTML = '<span class="card-name">' + name + '</span><span class="badge ok">OK</span>';
    g.appendChild(d);
  });
}
function buildGridJustif(id, list) {
  const g = document.getElementById(id); g.innerHTML = '';
  if (!list.length) { emptyMsg(id); return; }
  list.forEach(function(t) {
    const d = document.createElement('div'); d.className = 'card justif';
    d.innerHTML = (t.obs ? '<div class="justif-obs">' + t.obs + '</div>' : '') +
      '<span class="card-name">' + t.name + '</span><span class="badge justif">JUSTIF.</span>';
    g.appendChild(d);
  });
}
function buildGridFalta(id, list) {
  const g = document.getElementById(id); g.innerHTML = '';
  if (!list.length) { emptyMsg(id); return; }
  list.forEach(name => {
    const d = document.createElement('div'); d.className = 'card absent';
    d.innerHTML = '<span class="card-name">' + name + '</span><span class="badge falta">FALTA</span>';
    g.appendChild(d);
  });
}
function statusBadge(s) {
  if (!s) return '';
  const map = {'EXECUTADO':'exec','SEM ACESSO':'semac','TEMPO CHUVOSO':'chuva','NÃƒO EXECUTADO':'naexec','NAO EXECUTADO':'naexec'};
  const cls = map[s] || 'exec';
  const lbl = s.length > 12 ? s.substring(0,12)+'...' : s;
  return '<span class="badge ' + cls + '">' + lbl + '</span>';
}
function renderProducao() {
  const allTeams = [...teams.ok, ...teams.justif.map(t=>t.name)].sort();
  const lancou  = allTeams.filter(n => producao[n]);
  const aguard  = allTeams.filter(n => !producao[n]);
  const totalV  = lancou.reduce((s,n)=>s+(producao[n]?producao[n].valor||0:0), 0);
  document.getElementById('prod-lancou-count').textContent = lancou.length;
  document.getElementById('prod-valor-total').textContent  =
    totalV > 0 ? 'R$ ' + totalV.toLocaleString('pt-BR',{minimumFractionDigits:2}) : '';
  document.getElementById('lbl-lancou').textContent = lancou.length;
  document.getElementById('lbl-aguard').textContent = aguard.length;
  const gl = document.getElementById('prod-lancou-grid'); gl.innerHTML = '';
  if (!lancou.length) {
    gl.innerHTML = '<div style="padding:18px;color:#bbb;font-size:0.82rem;font-weight:600;grid-column:1/-1;text-align:center;">Nenhum lancamento registrado</div>';
  } else {
    lancou.forEach(name => {
      const p = producao[name];
      const val = p.valor > 0 ? 'R$ ' + p.valor.toLocaleString('pt-BR',{minimumFractionDigits:2}) : 'R$ 0,00';
      const st = (p.status||[]).map(statusBadge).join('');
      const d = document.createElement('div'); d.className = 'prod-card';
      d.innerHTML = '<div class="prod-top"><span class="prod-name">' + name + '</span><span class="badge lancou">LANCOU</span></div>' +
        '<div class="prod-meta"><span class="prod-info lan">' + p.lancamentos + ' lancamento' + (p.lancamentos>1?'s':'') + '</span>' +
        '<span class="prod-info val">R$ ' + (p.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2}) + '</span>' + st + '</div>';
      gl.appendChild(d);
    });
  }
  const ga = document.getElementById('prod-aguard-grid'); ga.innerHTML = '';
  if (!aguard.length) {
    ga.innerHTML = '<div style="padding:18px;color:#bbb;font-size:0.82rem;font-weight:600;grid-column:1/-1;text-align:center;">Todas as equipes ja lancaram!</div>';
  } else {
    aguard.forEach(name => {
      const d = document.createElement('div'); d.className = 'prod-card pending';
      d.innerHTML = '<div class="prod-top"><span class="prod-name">' + name + '</span><span class="badge aguard">AGUARD.</span></div>' +
        '<div class="prod-meta"><span class="prod-info">Sem lancamento</span></div>';
      ga.appendChild(d);
    });
  }
}
function allNames() { return [...teams.ok, ...teams.justif.map(t=>t.name), ...teams.falta]; }
async function addTeam() {
  const input = document.getElementById('new-name');
  const name  = input.value.trim().toUpperCase();
  const obs   = document.getElementById('new-obs').value.trim();
  if (!name) { showMsg('Informe o nome da equipe.','error'); return; }
  if (allNames().includes(name)) { showMsg(name + ' ja esta na lista.','error'); return; }
  if (selectedStatus === 'justif') teams.justif.push({name,obs});
  else teams[selectedStatus].push(name);
  render();
  input.value = ''; document.getElementById('new-obs').value = ''; input.focus();
  const labels = {ok:'ABRIU TURNO',justif:'FALTA JUSTIFICADA',falta:'NAO ABRIU'};
  showMsg(name + ' adicionada como ' + labels[selectedStatus],'success');
  await dbSaveTurno();
}
async function moveTeam(name, from, to) {
  if (from === 'justif') teams.justif = teams.justif.filter(t=>t.name!==name);
  else teams[from] = teams[from].filter(t=>t!==name);
  if (to === 'justif') {
    const obs = prompt('Motivo da justificativa para ' + name + ':') || '';
    teams.justif.push({name,obs});
  } else teams[to].push(name);
  render(); renderManageList();
  await dbSaveTurno();
}
async function removeTeam(name, from) {
  if (!confirm('Remover ' + name + ' da lista?')) return;
  if (from === 'justif') teams.justif = teams.justif.filter(t=>t.name!==name);
  else teams[from] = teams[from].filter(t=>t!==name);
  render(); renderManageList();
  await dbSaveTurno();
}
async function updateDate() {
  const val = document.getElementById('date-input').value.trim();
  if (!val) return;
  currentDate = val; render();
  showMsg('Data atualizada: ' + val,'success');
  await dbSaveTurno();
}
function renderManageList() {
  const q  = document.getElementById('search-input').value.trim().toUpperCase();
  const el = document.getElementById('manage-list'); el.innerHTML = '';
  const all = [
    ...teams.ok.map(n=>({n,s:'ok',obs:''})),
    ...teams.justif.map(t=>({n:t.name,s:'justif',obs:t.obs})),
    ...teams.falta.map(n=>({n,s:'falta',obs:''}))
  ].filter(t=>!q||t.n.includes(q)).sort((a,b)=>a.n.localeCompare(b.n));
  if (!all.length) { el.innerHTML='<div style="padding:16px;text-align:center;color:#bbb;font-size:0.82rem;">Nenhuma equipe encontrada</div>'; return; }
  const labels = {ok:'OK',justif:'JUSTIF.',falta:'FALTA'};
  all.forEach(function(item) {
    const n=item.n,s=item.s,obs=item.obs;
    const row = document.createElement('div'); row.className = 'team-row';
    const btns = ['ok','justif','falta'].filter(x=>x!==s).map(to =>
      '<button class="btn-sm to-' + to + '" onclick="moveTeam(\'' + n + '\',\'' + s + '\',\'' + to + '\')">' +
        (to==='ok'?'OK':to==='justif'?'JUSTIF.':'FALTA') + '</button>'
    ).join('');
    row.innerHTML = '<span class="team-row-name">' + n + '</span>' +
      (obs ? '<span style="font-size:0.7rem;color:#888;font-weight:600;flex-basis:100%;padding:2px 0 4px;">' + obs + '</span>' : '') +
      '<span class="pill ' + s + '">' + labels[s] + '</span>' +
      '<div class="team-row-acts">' + btns +
      '<button class="btn-sm del" onclick="removeTeam(\'' + n + '\',\'' + s + '\')">Remover</button></div>';
    el.appendChild(row);
  });
}
function parseCsvLine(line) {
  const result=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++) {
    const c=line[i];
    if(c==='"'){inQ=!inQ;continue;}
    if(c===';'&&!inQ){result.push(cur);cur='';continue;}
    cur+=c;
  }
  result.push(cur); return result;
}
async function handleCSV(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      lines[0] = lines[0].replace(/^\uFEFF/,'');
      const headers = lines[0].split(';').map(h=>h.trim().replace(/^"|"$/g,''));
      const idx = col => headers.findIndex(h=>h.replace(/^\uFEFF/,'').toLowerCase()===col.toLowerCase());
      // Suporta formato novo (Equipe, SituaÃ§Ã£o...) e formato antigo (des_equipe...)
      const iEq  = idx('Equipe')    >= 0 ? idx('Equipe')    : idx('des_equipe');
      const iVal = idx('valor_total');
      const iSt  = idx('SituaÃ§Ã£o')  >= 0 ? idx('SituaÃ§Ã£o')  : idx('retorno_campo');
      const iAb  = idx('Data inÃ­cio') >= 0 ? idx('Data inÃ­cio') : idx('abertura_turno');
      const iFe  = idx('Data fim')  >= 0 ? idx('Data fim')  : idx('fechamento_turno');
      const iRe  = idx('ResponsÃ¡vel') >= 0 ? idx('ResponsÃ¡vel') : idx('responsavel');
      const iSup = idx('Supervisor');
      const iOT  = idx('OT');
      if(iEq<0){showProdMsg('Coluna de equipe nao encontrada no CSV.','error');return;}
      const nova={};
      for(let i=1;i<lines.length;i++){
        const cols=parseCsvLine(lines[i]);
        if(cols.length<5)continue;
        const eq=(cols[iEq]||'').trim(); if(!eq)continue;
        if(!nova[eq])nova[eq]={lancamentos:0,ots:[],valor:0,status:[],abertura:'',fechamento:'',responsavel:'',supervisor:''};
        nova[eq].lancamentos++;
        const ot=(cols[iOT]||'').trim(); if(ot&&!nova[eq].ots.includes(ot))nova[eq].ots.push(ot);
        try{const v=parseFloat((cols[iVal]||'0').replace(',','.'));if(!isNaN(v))nova[eq].valor+=v;}catch(e){}
        const st=(cols[iSt]||'').trim(); if(st&&!nova[eq].status.includes(st))nova[eq].status.push(st);
        if(cols[iAb])nova[eq].abertura=cols[iAb].trim();
        if(cols[iFe])nova[eq].fechamento=cols[iFe].trim();
        nova[eq].responsavel=(cols[iRe]||'').replace(/^"|"$/g,'').trim();
        nova[eq].supervisor=(cols[iSup]||'').replace(/^"|"$/g,'').trim();
      }
      producao=nova;
      renderProducao();
      const qtdEq=Object.keys(nova).length;
      const totalL=Object.values(nova).reduce((s,v)=>s+v.lancamentos,0);
      const totalV=Object.values(nova).reduce((s,v)=>s+v.valor,0);
      document.getElementById('prod-summary').style.display='block';
      document.getElementById('prod-summary-stats').innerHTML=
        '<div><span class="prod-stat-val">'+qtdEq+'</span><span class="prod-stat-lbl">Equipes</span></div>' +
        '<div><span class="prod-stat-val">'+totalL+'</span><span class="prod-stat-lbl">Lancamentos</span></div>' +
        '<div><span class="prod-stat-val">R$ '+totalV.toLocaleString('pt-BR',{minimumFractionDigits:2})+'</span><span class="prod-stat-lbl">Valor total</span></div>';
      showProdMsg(qtdEq + ' equipes importadas com sucesso!','success');
      await dbSaveProducao();
    } catch(err){ showProdMsg('Erro ao ler o arquivo: '+err.message,'error'); }
  };
  reader.readAsText(file,'utf-8');
}
async function limparProducao() {
  if (!confirm('Limpar todos os dados de producao?')) return;
  producao={}; renderProducao();
  document.getElementById('prod-summary').style.display='none';
  showProdMsg('Dados removidos.','success');
  await dbSaveProducao();
}
function selectStatus(s) {
  selectedStatus=s;
  document.getElementById('opt-ok').className    ='radio-opt'+(s==='ok'    ?' sel-ok':'');
  document.getElementById('opt-justif').className='radio-opt'+(s==='justif'?' sel-justif':'');
  document.getElementById('opt-falta').className ='radio-opt'+(s==='falta' ?' sel-falta':'');
  document.getElementById('obs-group').style.display=s==='justif'?'block':'none';
}
function switchTab(tab) {
  ['add','manage','import','prod'].forEach(t=>{
    document.getElementById('tab-'+t).style.display=t===tab?'block':'none';
    document.getElementById('tab-'+t+'-btn').className='tab-btn'+(t===tab?' active-tab':'');
  });
  if(tab==='manage')renderManageList();
}
function showImportMsg(text,type) {
  const el=document.getElementById('import-msg');
  el.textContent=text; el.className='msg '+type;
  clearTimeout(el._t); el._t=setTimeout(()=>el.className='msg',5000);
}
async function handleTurnoCSV(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if (lines.length < 2) { showImportMsg('Arquivo vazio.','error'); return; }
      lines[0] = lines[0].replace(/^\uFEFF/,'');
      const headers = lines[0].split(';').map(h=>h.trim().replace(/^"|"$/g,''));
      const iEq = headers.findIndex(h=>h.toLowerCase()==='equipe');
      const iSt = headers.findIndex(h=>h.toLowerCase()==='situaÃ§Ã£o' || h.toLowerCase()==='situacao');
      if (iEq < 0) { showImportMsg('Coluna "Equipe" nao encontrada.','error'); return; }
      const novaOk = [];
      const novaFalta = [];
      for (let i=1; i<lines.length; i++) {
        const cols = lines[i].split(';').map(c=>c.trim().replace(/^"|"$/g,''));
        const eq = (cols[iEq]||'').trim().toUpperCase();
        if (!eq) continue;
        const st = iSt >= 0 ? (cols[iSt]||'').trim().toLowerCase() : 'aberto';
        // Aberto = abriu turno; qualquer outra coisa = falta
        if (st === 'aberto' || st === 'fechado') {
          if (!novaOk.includes(eq)) novaOk.push(eq);
        } else {
          if (!novaFalta.includes(eq)) novaFalta.push(eq);
        }
      }
      // Mantem justificadas, move o resto
      const justifNames = teams.justif.map(t=>t.name);
      teams.ok    = novaOk.filter(n=>!justifNames.includes(n));
      teams.falta = novaFalta.filter(n=>!justifNames.includes(n));
      // Equipes que estavam em falta mas agora abriram: remove de falta
      const todosNoCsv = [...novaOk, ...novaFalta];
      // Equipes que nao estao no CSV ficam onde estavam
      const allKnown = allNames();
      allKnown.forEach(n=>{
        if (!todosNoCsv.includes(n) && !justifNames.includes(n)) {
          if (!teams.ok.includes(n) && !teams.falta.includes(n)) teams.falta.push(n);
        }
      });
      render();
      await dbSaveTurno();
      showImportMsg(novaOk.length+' abriram turno, '+novaFalta.length+' faltaram. Dados salvos!','success');
    } catch(err) { showImportMsg('Erro: '+err.message,'error'); }
  };
  reader.readAsText(file,'utf-8');
}
function openModal()  { document.getElementById('modal-overlay').classList.add('open'); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target.id==='modal-overlay')closeModal();});
function showMsg(text,type) {
  const el=document.getElementById('add-msg');
  el.textContent=text; el.className='msg '+type;
  clearTimeout(el._t); el._t=setTimeout(()=>el.className='msg',3500);
}
function showProdMsg(text,type) {
  const el=document.getElementById('prod-msg');
  el.textContent=text; el.className='msg '+type;
  clearTimeout(el._t); el._t=setTimeout(()=>el.className='msg',4000);
}
async function atualizarRelatorio() {
  const btn=document.getElementById('btn-refresh');
  btn.innerHTML='<span class="spinning-icon">&#8635;</span> ATUALIZANDO...'; btn.disabled=true;
  await dbLoad(); render();
  const now=new Date(); const pad=n=>String(n).padStart(2,'0');
  const genTime=pad(now.getDate())+'/'+pad(now.getMonth()+1)+'/'+now.getFullYear()+' as '+pad(now.getHours())+':'+pad(now.getMinutes());
  document.getElementById('page-time').textContent='Atualizado em: '+genTime;
  btn.innerHTML='&#8635; ATUALIZAR'; btn.disabled=false;
}
function tirarPrint() {
  const b1=document.querySelector('.fab'),b2=document.querySelector('.btn-print'),b3=document.querySelector('.btn-refresh');
  [b1,b2,b3].forEach(b=>{if(b)b.style.display='none';});
  b2.textContent='Gerando...';
  const load=()=>{
    html2canvas(document.body,{scale:2,useCORS:true,backgroundColor:'#f0f2f5',scrollY:-window.scrollY,windowHeight:document.body.scrollHeight}).then(canvas=>{
      const a=document.createElement('a');
      a.download='turno_'+currentDate.replace(/\//g,'-')+'.png'; a.href=canvas.toDataURL('image/png'); a.click();
      [b1,b2,b3].forEach(b=>{if(b)b.style.display='';});
      b2.textContent='SALVAR PRINT';
    });
  };
  if(window.html2canvas){load();}
  else{const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';s.onload=load;document.head.appendChild(s);}
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideLoading() {
  const el = document.getElementById('loading-overlay');
  el.classList.remove('show');
  el.style.display = 'none';
  el.style.pointerEvents = 'none';
}

(async function() {
  const now=new Date(); const pad=n=>String(n).padStart(2,'0');
  document.getElementById('page-time').textContent =
    'Gerado em: '+pad(now.getDate())+'/'+pad(now.getMonth()+1)+'/'+now.getFullYear()+' as '+pad(now.getHours())+':'+pad(now.getMinutes());
  try { await dbLoad(); } catch(e) {}
  render();
  hideLoading();
})();
</script>
</body>
</html>
