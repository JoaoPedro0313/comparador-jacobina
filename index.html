<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparador ¬∑ Cava & Postes</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161921;
    --border: #252a35;
    --accent: #f0a500;
    --green: #2ecc71;
    --red: #e74c3c;
    --blue: #3498db;
    --muted: #5a6478;
    --text: #d4dae8;
    --text-bright: #f0f4ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    padding: 0 0 60px;
  }

  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  header .logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 28px;
    font-weight: 900;
    letter-spacing: 2px;
    color: var(--accent);
    text-transform: uppercase;
  }

  header .subtitle {
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .container { max-width: 1400px; margin: 0 auto; padding: 0 40px; }

  /* UPLOAD ZONE */
  .upload-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    padding: 40px 0 30px;
  }

  .upload-card {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 36px 24px;
    text-align: center;
    transition: border-color 0.2s, background 0.2s;
    cursor: pointer;
    position: relative;
  }

  .upload-card:hover { border-color: var(--accent); background: #1c2030; }
  .upload-card.loaded { border-style: solid; border-color: var(--green); }

  .upload-card input[type=file] {
    position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
  }

  .upload-card .tag {
    display: inline-block;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 2px;
    margin-bottom: 14px;
  }
  .tag.anterior { background: #1e2a3a; color: var(--blue); }
  .tag.atual { background: #1e2d1e; color: var(--green); }

  .upload-card .icon { font-size: 40px; margin-bottom: 12px; }
  .upload-card .label { font-size: 14px; color: var(--muted); }
  .upload-card .filename {
    margin-top: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    word-break: break-all;
  }

  /* STATS BAR */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin: 8px 0 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 18px 20px;
    border-top: 3px solid var(--accent);
  }
  .stat-card.green { border-top-color: var(--green); }
  .stat-card.red { border-top-color: var(--red); }
  .stat-card.blue { border-top-color: var(--blue); }

  .stat-card .val {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--text-bright);
  }
  .stat-card .lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }

  /* FILTERS */
  .toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .toolbar label { font-size: 12px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

  .filter-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'Barlow', sans-serif;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }

  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'Barlow', sans-serif;
    width: 280px;
    margin-left: auto;
  }
  .search-input:focus { outline: none; border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  /* TABLE */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead tr {
    background: #0d0f14;
    border-bottom: 2px solid var(--accent);
  }

  th {
    padding: 14px 16px;
    text-align: left;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  tbody tr:hover { background: #1c2030; }
  tbody tr:last-child { border-bottom: none; }

  td { padding: 12px 16px; vertical-align: middle; }

  .td-title { max-width: 260px; }
  .td-title .main { color: var(--text-bright); font-weight: 500; }
  .td-title .pep { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .status-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .status-EM_EXECUCAO { background: #1a2e40; color: var(--blue); }
  .status-ENERGIZADA { background: #1a2d1a; color: var(--green); }
  .status-PROGRAMADA { background: #2a2a1a; color: #f0e040; }
  .status-CANCELADA { background: #2d1a1a; color: var(--red); }
  .status-DEFAULT { background: #1e2030; color: var(--muted); }

  .diff-cell {
    text-align: center;
    min-width: 120px;
  }

  .diff-val { display: flex; align-items: center; justify-content: center; gap: 8px; }

  .old-val {
    font-size: 13px;
    color: var(--muted);
    text-decoration: line-through;
    text-decoration-color: var(--red);
  }

  .arrow { color: var(--muted); font-size: 12px; }

  .new-val {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-bright);
  }

  .delta {
    display: inline-block;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 3px;
    margin-left: 4px;
  }
  .delta.pos { background: rgba(46,204,113,0.15); color: var(--green); }
  .delta.neg { background: rgba(231,76,60,0.15); color: var(--red); }
  .delta.zero { background: rgba(90,100,120,0.2); color: var(--muted); }

  .no-change { color: var(--muted); text-align: center; font-size: 13px; }

  /* EMPTY */
  .empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--muted);
  }
  .empty-state .big { font-size: 60px; margin-bottom: 20px; }
  .empty-state .msg { font-size: 16px; }

  .section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-bright);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .btn-compare {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 12px 36px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.2s;
    display: block;
    margin: 24px auto;
  }
  .btn-compare:hover { opacity: 0.85; }
  .btn-compare:disabled { opacity: 0.3; cursor: not-allowed; }

  .count-tag {
    background: var(--accent);
    color: #000;
    font-size: 12px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 3px;
    margin-left: 6px;
  }

  .legend {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
    font-size: 12px;
    color: var(--muted);
    align-items: center;
  }
  .legend span { display: flex; align-items: center; gap: 6px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">‚ö° Carteira de Obras</div>
    <div class="subtitle">Comparador de Altera√ß√µes ¬∑ Cava & Postes</div>
  </div>
</header>

<div class="container">

  <!-- UPLOAD -->
  <div class="upload-section">
    <div class="upload-card" id="card-anterior">
      <input type="file" id="file-anterior" accept=".csv">
      <div class="tag anterior">Arquivo Anterior</div>
      <div class="icon">üìÇ</div>
      <div class="label">Clique para selecionar o CSV anterior</div>
      <div class="filename" id="name-anterior"></div>
    </div>
    <div class="upload-card" id="card-atual">
      <input type="file" id="file-atual" accept=".csv">
      <div class="tag atual">Arquivo Atual</div>
      <div class="icon">üìÇ</div>
      <div class="label">Clique para selecionar o CSV atual</div>
      <div class="filename" id="name-atual"></div>
    </div>
  </div>

  <button class="btn-compare" id="btn-compare" disabled onclick="compare()">
    üîç Comparar Arquivos
  </button>

  <div id="results" style="display:none">

    <!-- STATS -->
    <div class="section-title">Resumo das Altera√ß√µes</div>
    <div class="stats-bar">
      <div class="stat-card blue">
        <div class="val" id="stat-total">0</div>
        <div class="lbl">Obras com altera√ß√£o</div>
      </div>
      <div class="stat-card green">
        <div class="val" id="stat-cava-inc">0</div>
        <div class="lbl">Cava aumentou</div>
      </div>
      <div class="stat-card red">
        <div class="val" id="stat-cava-dec">0</div>
        <div class="lbl">Cava reduziu</div>
      </div>
      <div class="stat-card green">
        <div class="val" id="stat-postes-inc">0</div>
        <div class="lbl">Postes realiz. aumentou</div>
      </div>
      <div class="stat-card red">
        <div class="val" id="stat-postes-dec">0</div>
        <div class="lbl">Postes realiz. reduziu</div>
      </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <label>Filtrar:</label>
      <button class="filter-btn active" onclick="setFilter('todos', this)">Todos</button>
      <button class="filter-btn" onclick="setFilter('cava', this)">Cava</button>
      <button class="filter-btn" onclick="setFilter('postes', this)">Postes Realiz.</button>
      <button class="filter-btn" onclick="setFilter('implantados', this)">Postes √† Implantar</button>
      <input class="search-input" type="text" id="search" placeholder="üîç Buscar por obra, PEP..." oninput="renderTable()">
    </div>

    <div class="legend">
      <span><span class="dot" style="background:var(--green)"></span> Aumentou</span>
      <span><span class="dot" style="background:var(--red)"></span> Reduziu</span>
      <span><span class="dot" style="background:var(--muted)"></span> Sem altera√ß√£o</span>
    </div>

    <!-- TABLE -->
    <div class="section-title">Detalhamento <span class="count-tag" id="count-label">0</span></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>PEP Obra</th>
            <th>T√≠tulo</th>
            <th>Status</th>
            <th class="diff-cell">Cava Realizada</th>
            <th class="diff-cell">Postes Realizados</th>
            <th class="diff-cell">Postes √† Implantar</th>
            <th class="diff-cell">Postes Previstos</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>

let dataAnterior = null;
let dataAtual = null;
let allChanges = [];
let activeFilter = 'todos';

// --- FILE LOADING ---
function handleFile(inputId, cardId, nameId, side) {
  const input = document.getElementById(inputId);
  input.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    document.getElementById(nameId).textContent = file.name;
    document.getElementById(cardId).classList.add('loaded');

    Papa.parse(file, {
      skipEmptyLines: true,
      complete: function(results) {
        const rows = results.data;
        // Find header row (contains "NOTA" and "PEP OBRA")
        let headerIdx = -1;
        for (let i = 0; i < rows.length; i++) {
          const r = rows[i].map(c => String(c).trim().toUpperCase());
          if (r.includes('NOTA') && r.some(c => c.includes('PEP'))) {
            headerIdx = i;
            break;
          }
        }
        if (headerIdx === -1) { alert('N√£o encontrei cabe√ßalho v√°lido no arquivo.'); return; }

        const headers = rows[headerIdx].map(c => String(c).trim().replace(/\n/g,' ').toUpperCase());
        const data = [];
        for (let i = headerIdx + 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row.some(c => String(c).trim())) continue;
          const obj = {};
          headers.forEach((h, idx) => { obj[h] = String(row[idx] || '').trim(); });
          if (obj['PEP OBRA'] && obj['PEP OBRA'] !== '') data.push(obj);
        }

        if (side === 'anterior') dataAnterior = data;
        else dataAtual = data;

        if (dataAnterior && dataAtual) {
          document.getElementById('btn-compare').disabled = false;
        }
      }
    });
  });
}

handleFile('file-anterior', 'card-anterior', 'name-anterior', 'anterior');
handleFile('file-atual', 'card-atual', 'name-atual', 'atual');

// --- PARSE NUMBER ---
function parseNum(v) {
  if (v === '' || v === null || v === undefined || v === 'nan' || v === 'NaN') return null;
  const n = parseFloat(String(v).replace(',', '.'));
  return isNaN(n) ? null : n;
}

// --- COMPARE ---
function compare() {
  const mapAnterior = {};
  dataAnterior.forEach(r => { mapAnterior[r['PEP OBRA']] = r; });

  allChanges = [];

  dataAtual.forEach(rowAtual => {
    const pep = rowAtual['PEP OBRA'];
    const rowAnt = mapAnterior[pep];

    const cols = [
      { key: 'CAVA REALIZADA', label: 'Cava' },
      { key: 'POSTES  REALIZADO', label: 'Postes Realiz.' },
      { key: 'POSTES   IMPLANTA', label: 'Postes √† Imp.' },
    ];

    // Try multiple possible column name variants
    const findVal = (row, keyword) => {
      if (!row) return null;
      const k = Object.keys(row).find(k => k.toUpperCase().replace(/\s+/g,'').includes(keyword.replace(/\s+/g,'')));
      return k ? parseNum(row[k]) : null;
    };

    const cavaAnt = rowAnt ? findVal(rowAnt, 'CAVAREALIZADA') : null;
    const cavaAtual = findVal(rowAtual, 'CAVAREALIZADA');
    const postesRealAnt = rowAnt ? findVal(rowAnt, 'POSTESREALIZADO') : null;
    const postesRealAtual = findVal(rowAtual, 'POSTESREALIZADO');
    const postesImpAnt = rowAnt ? findVal(rowAnt, 'POSTESIMPLAN') : null;
    const postesImpAtual = findVal(rowAtual, 'POSTESIMPLAN');
    const postesPrevAtual = findVal(rowAtual, 'POSTESPREVISTOS');

    const cavaDiff = (cavaAnt !== null || cavaAtual !== null) ? (cavaAtual || 0) - (cavaAnt || 0) : 0;
    const postesRealDiff = (postesRealAnt !== null || postesRealAtual !== null) ? (postesRealAtual || 0) - (postesRealAnt || 0) : 0;
    const postesImpDiff = (postesImpAnt !== null || postesImpAtual !== null) ? (postesImpAtual || 0) - (postesImpAnt || 0) : 0;

    const hasChange = cavaDiff !== 0 || postesRealDiff !== 0 || postesImpDiff !== 0;
    if (!hasChange && rowAnt) return;

    const statusRaw = String(rowAtual['STATUS DA OBRA'] || rowAtual['STATUS'] || '').trim().toUpperCase().replace(/\s+/g,'_');

    allChanges.push({
      pep,
      titulo: rowAtual['T√çTULO'] || rowAtual['TITULO'] || '',
      status: statusRaw,
      isNew: !rowAnt,
      cavaAnt, cavaAtual, cavaDiff,
      postesRealAnt, postesRealAtual, postesRealDiff,
      postesImpAnt, postesImpAtual, postesImpDiff,
      postesPrevAtual
    });
  });

  // Stats
  document.getElementById('stat-total').textContent = allChanges.length;
  document.getElementById('stat-cava-inc').textContent = allChanges.filter(r => r.cavaDiff > 0).length;
  document.getElementById('stat-cava-dec').textContent = allChanges.filter(r => r.cavaDiff < 0).length;
  document.getElementById('stat-postes-inc').textContent = allChanges.filter(r => r.postesRealDiff > 0).length;
  document.getElementById('stat-postes-dec').textContent = allChanges.filter(r => r.postesRealDiff < 0).length;

  document.getElementById('results').style.display = 'block';
  renderTable();

  document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

// --- FILTER ---
function setFilter(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

// --- RENDER ---
function renderTable() {
  const search = document.getElementById('search').value.toLowerCase();

  let rows = allChanges.filter(r => {
    if (search && !r.titulo.toLowerCase().includes(search) && !r.pep.toLowerCase().includes(search)) return false;
    if (activeFilter === 'cava' && r.cavaDiff === 0) return false;
    if (activeFilter === 'postes' && r.postesRealDiff === 0) return false;
    if (activeFilter === 'implantados' && r.postesImpDiff === 0) return false;
    return true;
  });

  document.getElementById('count-label').textContent = rows.length;

  const tbody = document.getElementById('table-body');
  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="big">üîç</div><div class="msg">Nenhuma altera√ß√£o encontrada com os filtros aplicados</div></div></td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const statusClass = `status-${r.status}`;
    const statusLabel = r.status.replace(/_/g, ' ');
    const newTag = r.isNew ? `<span style="color:var(--accent);font-size:11px;font-weight:700;margin-left:6px">NOVA</span>` : '';

    return `<tr>
      <td><code style="color:var(--accent);font-size:12px">${r.pep}</code></td>
      <td class="td-title">
        <div class="main">${r.titulo}${newTag}</div>
      </td>
      <td><span class="status-badge ${statusClass} status-DEFAULT">${statusLabel}</span></td>
      <td class="diff-cell">${diffCell(r.cavaAnt, r.cavaAtual, r.cavaDiff)}</td>
      <td class="diff-cell">${diffCell(r.postesRealAnt, r.postesRealAtual, r.postesRealDiff)}</td>
      <td class="diff-cell">${diffCell(r.postesImpAnt, r.postesImpAtual, r.postesImpDiff)}</td>
      <td class="diff-cell"><span style="color:var(--muted)">${r.postesPrevAtual !== null ? r.postesPrevAtual : '‚Äî'}</span></td>
    </tr>`;
  }).join('');
}

function diffCell(ant, atual, diff) {
  const antDisplay = ant !== null ? ant : '‚Äî';
  const atualDisplay = atual !== null ? atual : '‚Äî';

  if (diff === 0) {
    return `<span class="no-change">${atualDisplay}</span>`;
  }

  const sign = diff > 0 ? '+' : '';
  const cls = diff > 0 ? 'pos' : 'neg';

  return `<div class="diff-val">
    <span class="old-val">${antDisplay}</span>
    <span class="arrow">‚Üí</span>
    <span class="new-val">${atualDisplay}</span>
    <span class="delta ${cls}">${sign}${diff}</span>
  </div>`;
}

</script>
</body>
</html>
